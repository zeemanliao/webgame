var Player = require('./class/Player');
module.exports = function(io, game) {
  /*************************************************************************************
   **************************************************************************************
   ************************************私人連線*******************************************
   **************************************************************************************
   *************************************************************************************/
  io.sockets.on('connection', function(socket) {
    var player = null;
    game.checkLogin();


    /*************************************************************************************
     **************************************************************************************
     ************************************動作程式*******************************************
     **************************************************************************************
     *************************************************************************************/
    socket.on('act', function(data) {
      try{
        if (!data || !data.com || !data.com2)
          return;

        if (!game.routes[data.com] || !game.routes[data.com][data.com2])
          return;
        
        if (tool.isUndefinedOrNull(data.data))
          return;

        game.routes[data.com][data.com2](player, data.data);
      } catch (e) {
        var msg = e.message + '</br>' + e.stack ? e.stack:'';
        socket.emit('show error',msg);
      }
    });

    socket.on('check ver', function(data) {
        try{
            game.updateLocalStorage(player, data);
        } catch (e) {
            var msg = e.message + '</br>' + e.stack ? e.stack:'';
            socket.emit('show error',msg);
        }
        
    });
    /*************************************************************************************
     **************************************************************************************
     ************************************共用程式*******************************************
     **************************************************************************************
     *************************************************************************************/

    //斷線
    socket.on('disconnect', function() {
        //離開
        var playerID = socket.handshake.session.playerID;
        
        game.leave(player, function(err) {
            if (!err)
                console.log('....................%s Login Out', playerID);
        });
    });
  });
};